<!doctype html>
<html lang="{{ get_locale() or 'ru' }}">
<head>
<meta charset="utf-8">
<title>{{ (page_title or _('–ó–∞—è–≤–∫–∏')) ~ ' ¬∑ ' ~ _('–õ–∏–¥–µ—Ä—ã –≥–æ–¥–∞') }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--g:#1c7a45;--bg:#f6f7f8;--border:#e5e7eb;--muted:#64748b;--shadow:0 8px 30px rgba(0,0,0,.06);--green:#22c55e}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg)}
.layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}

/* aside */
.aside{background:var(--g);color:#fff;padding:16px 12px}
.brand{display:flex;align-items:center;gap:10px;padding:8px 10px;margin-bottom:14px}
.brand img{width:36px;height:36px;border-radius:50%}
.nav{display:flex;flex-direction:column;gap:6px}
.nav a{display:flex;align-items:center;gap:10px;color:#e8fbee;text-decoration:none;padding:10px 12px;border-radius:10px}
.nav a.active{background:#0e5935;color:#fff}

/* topbar */
.topbar{background:#fff;border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center;justify-content:flex-end;gap:14px;padding:0 18px}
.user{display:flex;align-items:center;gap:10px}
.user .avatar{width:34px;height:34px;border-radius:50%;background:#e5f6ec;color:#1e824f;display:grid;place-items:center;font-weight:700}
.user .who{display:flex;flex-direction:column;line-height:1.1}
.user .name{font-size:14px;font-weight:600}
.user .role{font-size:12px;color:#475569}

/* content */
.content{padding:18px 22px}
.h1{font-size:20px;font-weight:700;margin:8px 0 14px}
.filters{display:flex;gap:8px;align-items:center;margin:6px 0 16px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#e8f7ef;color:#0b7a45;font-weight:600;font-size:12px}
.chip .cnt{display:inline-grid;place-items:center;width:18px;height:18px;border-radius:50%;background:#0b7a45;color:#fff;font-weight:700;font-size:12px}

/* status chip */
.chip--status{background:#eef2ff;color:#3730a3}
.chip--status.ok{background:#e8f7ef;color:#065f46}
.chip--status.bad{background:#fee2e2;color:#9f1239}

/* bullets */
.bullets{margin:6px 0 4px; padding-left:18px; color:#0f172a}
.bullets li{margin:6px 0}
.bullets .sub{margin-top:6px; padding-left:18px}
.bullets b{font-weight:700}

/* cards / table */
.card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:16px 18px;max-width:860px}
.card + .card{margin-top:14px}
.card-title{font-weight:700;margin:2px 0 12px}
.table{width:100%}
.header{display:grid;grid-template-columns:150px 1fr 220px;gap:12px;color:#0f172a;font-weight:600;font-size:14px;margin-bottom:8px}
.row{display:grid;grid-template-columns:150px 1fr 220px;gap:12px;align-items:center;padding:6px 0;border-top:1px solid #eef1f4}
.row .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.muted{color:var(--muted);font-size:12px}
.btn{border:none;background:var(--green);color:#fff;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer}
.empty{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:24px;text-align:center;color:var(--muted);max-width:860px}

/* modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;z-index:1000}
.overlay.open{display:grid}
.modal{
  width:min(900px,94vw);background:#fff;border:1px solid var(--border);border-radius:14px;
  box-shadow:0 20px 60px rgba(2,6,23,.18);overflow:hidden;
  display:flex;flex-direction:column;max-height:calc(var(--vh,1vh)*92);
}
.m-head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border)}
.m-title{font-weight:700}
.m-close{appearance:none;border:none;background:transparent;font-size:22px;cursor:pointer}

/* stepper (5 —à–∞–≥–æ–≤) */
.stepper{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:14px 18px;border-bottom:1px solid var(--border)}
.step{display:flex;flex-direction:column;align-items:center;gap:6px;color:#64748b;text-align:center}
.step .dot{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;border:2px solid #d1d5db;background:#fff;font-weight:700}
.step.active{color:#0f172a}
.step.active .dot{background:var(--green);border-color:var(--green);color:#fff}

.content-modal{padding:18px;flex:1 1 auto;overflow-y:auto;-webkit-overflow-scrolling:touch}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
.field input,.field textarea{padding:10px;border:1px solid var(--border);border-radius:8px;background:#f9fafb}
.field textarea{min-height:90px;resize:vertical}

/* modal footer */
.row-end{display:flex;flex-wrap:wrap;justify-content:space-between;gap:8px;margin-top:12px;padding:12px 18px;border-top:1px solid var(--border);background:#fafafa}
.nav-buttons{display:flex;gap:8px}
.decision{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn-ghost{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
.btn-primary{padding:10px 16px;border:none;border-radius:10px;background:var(--green);color:#fff;font-weight:600;cursor:pointer}
.btn-danger{padding:10px 16px;border:none;border-radius:10px;background:#ef4444;color:#fff;font-weight:600;cursor:pointer}

/* reason input */
.reason-input{min-width:260px;max-width:420px;width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
@media (max-width:740px){.grid{grid-template-columns:1fr}}

/* —è–∑—ã–∫ */
.lang-switch{position:relative;display:inline-block}
.lang-menu{position:absolute;right:0;top:calc(100% + 6px);display:none;min-width:180px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 30px rgba(2,6,23,.18);z-index:1000;overflow:hidden}
.lang-switch.open .lang-menu{display:block}
.btn-lang{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;cursor:pointer}
.btn-lang img.flag-round,.lang-menu img.flag-round{width:22px;height:22px;max-width:22px;max-height:22px;object-fit:cover;border-radius:50%;display:inline-block}

/* ====== –®–∞–≥ 5: –í—Å–µ –ø–æ–ª—è ====== */
.kv-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 10px}
.kv-search{flex:1 1 260px;min-width:220px;max-width:520px;height:38px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
.kv-toolbar .chk{display:inline-flex;align-items:center;gap:8px;color:#475569}
.kv-grid{display:flex;flex-direction:column;gap:8px}
.kv-item{display:grid;grid-template-columns:minmax(200px,280px) 1fr auto;gap:10px;align-items:flex-start;padding:8px 10px;border:1px solid #eef1f4;border-radius:12px;background:#fff}
.kv-label{color:#334155;font-weight:600}
.kv-value{position:relative;background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word;max-height:none}
.kv-actions{display:flex;gap:8px}
.kv-copy{border:1px solid var(--border);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:600}
.kv-empty{display:inline-block;padding:2px 8px;border-radius:999px;background:#fee2e2;color:#9f1239;font-weight:700;font-size:12px}
.kv-value.collapsed{max-height:120px;overflow:hidden;-webkit-mask-image:linear-gradient(#000,rgba(0,0,0,0));mask-image:linear-gradient(#000,rgba(0,0,0,0))}
.kv-toggle{margin-top:6px;display:inline-block;border:none;background:transparent;color:#0b7a45;font-weight:700;cursor:pointer}

/* —è–∑—ã–∫ –ø–æ–≤—Ç–æ—Ä (–æ–∫) */
.lang-switch{position:relative;display:inline-block}
.btn-lang{
  display:inline-flex;align-items:center;gap:8px;
  background:#fff;border:1px solid #e5e7eb;border-radius:8px;
  padding:6px 10px; cursor:pointer; height:34px;
}
.btn-lang .caret{margin-left:4px; font-size:12px; opacity:.75}
.btn-lang img.flag-round{width:20px;height:20px;border-radius:50%}
.lang-menu{
  position:absolute; right:0; top:calc(100% + 8px); z-index:1000;
  display:none; min-width:200px; background:#fff;
  border:1px solid #e5e7eb; border-radius:12px;
  box-shadow:0 12px 30px rgba(2,6,23,.18); padding:6px;
}
.lang-switch.open .lang-menu{display:block}
.lang-item{
  display:flex; align-items:center; gap:10px;
  padding:8px 10px; border-radius:8px;
  text-decoration:none; color:#0f172a; line-height:1.2;
}
.lang-item:hover{background:#f8fafc}
.lang-item img.flag-round{width:20px;height:20px; border-radius:50%}
.lang-item .check{
  margin-left:auto; font-weight:700; color:var(--green); opacity:0;
  transition:opacity .12s ease;
}
.lang-item.active .check{opacity:1}

/* user dropdown */
.user-switch{ position:relative; }
.user-btn{
  display:flex; align-items:center; gap:10px;
  background:#fff; border:1px solid #e5e7eb; border-radius:999px;
  padding:6px 10px; cursor:pointer; height:36px;
  box-shadow:0 10px 30px -18px rgba(0,0,0,.45), 0 1px 0 rgba(0,0,0,.04);
}
.user-btn:focus-visible{ outline:none; box-shadow:0 0 0 4px rgba(34,197,94,.20), 0 10px 30px -18px rgba(0,0,0,.45); }
.user-btn .caret{ font-size:12px; opacity:.7; transition:transform .2s ease, opacity .2s ease; }
.user-switch.open .user-btn .caret{ transform:rotate(180deg); opacity:1; }
.user-inline{ display:flex; align-items:center; gap:10px; }
.user-inline .who{ display:flex; flex-direction:column; line-height:1.1; text-align:right; }
.user-inline .name{ font-size:14px; font-weight:600; }
.user-inline .role{ font-size:12px; color:#475569; }
.user-inline .avatar{
  width:34px; height:34px; border-radius:50%;
  background:#e5f6ec; color:#1e824f; display:grid; place-items:center; font-weight:700;
}
.user-menu{
  position:absolute; right:0; top:calc(100% + 8px); z-index:1000;
  display:none; min-width:220px; background:#fff;
  border:1px solid #e5e7eb; border-radius:12px;
  box-shadow:0 24px 60px rgba(2,6,23,.22); overflow:hidden;
  transform-origin:top right; transform:scale(.98); opacity:0;
  transition:transform .16s ease, opacity .16s ease;
}
.user-switch.open .user-menu{ display:block; transform:scale(1); opacity:1; }
.user-menu .menu-item,
.user-menu form button{
  width:100%; display:flex; align-items:center; gap:10px;
  padding:10px 12px; background:none; border:0; text-align:left;
  font:inherit; color:#111827; text-decoration:none; cursor:pointer;
}
.user-menu .menu-item:hover,
.user-menu form button:hover{ background:#f3f4f6; }
.user-menu .danger{ color:#b91c1c; }
.user-menu .danger:hover{ background:#fee2e2; }

.overlay--confirm{ z-index:1100; }
.modal-confirm{ width:min(420px,94vw); border-radius:12px; }
</style>
</head>
<body>
<div class="layout">
  <aside class="aside">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="">
      <strong>{{ _('–õ–∏–¥–µ—Ä—ã –≥–æ–¥–∞') }}</strong>
    </div>
    <nav class="nav">
      <a href="{{ url_for('admin.admin') }}" class="{{ 'active' if active=='apps' else '' }}">{{ _('–ó–∞—è–≤–∫–∏') }}</a>
      <a href="{{ url_for('admin.admin_tests') }}" class="{{ 'active' if active=='tests' else '' }}">{{ _('–¢–µ—Å—Ç—ã') }}</a>
    </nav>
  </aside>

  <div>
    <header class="topbar">
      {% set cur = (get_locale() or 'ru') %}
      {% set flags = {'ru': url_for('static', filename='ru.png'), 'ky': url_for('static', filename='ky.png')} %}
      <div class="lang-switch" id="langSwitch" style="margin-right:auto;padding-left:16px">
        <button class="btn-lang" type="button" aria-haspopup="listbox" aria-expanded="false">
          <img src="{{ flags[cur] }}" alt="" class="flag-round">
          <span class="lbl">{{ '–†—É—Å—Å–∫–∏–π' if cur=='ru' else '–ö—ã—Ä–≥—ã–∑—á–∞' }}</span>
          <span class="caret">‚ñæ</span>
        </button>
        <div class="lang-menu" role="listbox" aria-label="{{ _('–í—ã–±–æ—Ä —è–∑—ã–∫–∞') }}">
          <a class="lang-item {{ 'active' if cur=='ru' else '' }}"
             href="{{ url_for('set_locale', lang='ru', next=request.full_path) }}">
            <img src="{{ flags['ru'] }}" alt="" class="flag-round">
            <span>–†—É—Å—Å–∫–∏–π</span>
            <span class="check" aria-hidden="true">‚úì</span>
          </a>
          <a class="lang-item {{ 'active' if cur=='ky' else '' }}"
             href="{{ url_for('set_locale', lang='ky', next=request.full_path) }}">
            <img src="{{ flags['ky'] }}" alt="" class="flag-round">
            <span>–ö—ã—Ä–≥—ã–∑—á–∞</span>
            <span class="check" aria-hidden="true">‚úì</span>
          </a>
        </div>
      </div>

      <div class="user-switch" id="userSwitch" style="margin-left:8px;">
        <button class="user-btn" type="button" aria-haspopup="true" aria-expanded="false">
          <div class="user-inline">
            <div class="who">
              <span class="name">{{ user['full_name'] if user else _('–ê–¥–º–∏–Ω') }}</span>
              <span class="role">
                {{ _('–ö–æ–º–∏—Å—Å–∏—è') if user and user['role']=='admin' else _('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') }}
              </span>
            </div>
            <div class="avatar">{{ (user['full_name'][0] if user and user['full_name'] else 'A')|upper }}</div>
          </div>
          <span class="caret">‚ñæ</span>
        </button>
        <div class="user-menu" role="menu" aria-label="{{ _('–ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è') }}">
          <a class="menu-item" href="{{ url_for('main.profile', user_id=session['user_id']) }}">üë§ {{ _('–ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞') }}</a>
          <form action="{{ url_for('auth.logout') }}" method="post">
            <button type="submit" class="danger">üö™ {{ _('–í—ã–π—Ç–∏') }}</button>
          </form>
        </div>
      </div>
    </header>

    <main class="content">
      <div class="h1">{{ _('–ó–∞—è–≤–∫–∏') }}</div>
      <div class="filters">
        <span class="chip">{{ _('–í—Å–µ –∑–∞—è–≤–∫–∏') }} <span class="cnt">{{ items|length }}</span></span>
      </div>

      <div class="card" role="note" aria-label="{{ _('–≠—Ç–∞–ø 2: –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏') }}">
        <div class="card-title">{{ _('–≠—Ç–∞–ø 2: –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏') }}</div>
        <ul class="bullets">
          <li>{{ _('–ö–æ–º–∏—Å—Å–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏.') }}</li>
          <li>{{ _('–û—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –¥–∞–Ω–Ω—ã—Ö.') }}</li>
          <li>{{ _('–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ:') }}
            <ul class="sub">
              <li><b>{{ _('–û–¥–æ–±—Ä–µ–Ω–æ') }}</b> ‚Äî {{ _('–î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ 2-—ç—Ç–∞–ø –∫–æ–Ω–∫—É—Ä—Å–∞') }}</li>
              <li><b>{{ _('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') }}</b> ‚Äî {{ _('—Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω—ã.') }}</li>
            </ul>
          </li>
        </ul>
      </div>

      {% if items and items|length %}
        {% for it in items %}
          <div class="card" data-row="{{ it['id'] }}">
            <div class="card-title">{{ _('–ó–∞—è–≤–∫–∞ ‚Ññ') }} {{ it.public_no or loop.index }}</div>


            <div class="table">
              <div class="header">
                <div>{{ _('–î–∞—Ç–∞') }}</div>
                <div>{{ _('–§–ò–û') }}</div>
                <div class="right">{{ _('–°—Ç–∞—Ç—É—Å / –î–µ–π—Å—Ç–≤–∏—è') }}</div>
              </div>

              <div class="row">
                <div class="muted">{{ it['created_at'].strftime('%d.%m.%y') if it['created_at'] else '-' }}</div>
                <div>{{ it['full_name'] or '‚Äî' }}</div>
                <div class="right">
                  {% if it['commission_status'] %}
                    {% set code = it['commission_status'] %}
                    {% set label = _('–û–¥–æ–±—Ä–µ–Ω–æ') if code=='approved' else (_('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') if code=='rejected' else code) %}
                    <span class="chip chip--status chip-status {{ 'ok' if code=='approved' else ('bad' if code=='rejected' else '') }}">{{ label }}</span>
                  {% endif %}
                  <button class="btn details-btn" type="button" data-id="{{ it['id'] }}">{{ _('–î–µ—Ç–∞–ª–∏') }}</button>
                </div>
              </div>

            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty">{{ _('–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç') }}</div>
      {% endif %}
    </main>
  </div>
</div>

<!-- MODAL -->
<div id="detailsOverlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="m-head">
      <div class="m-title" id="mTitle">{{ _('–ó–∞—è–≤–∫–∞') }}</div>
      <button class="m-close" type="button" data-close>√ó</button>
    </div>

    <div class="stepper">
      <div class="step active"><div class="dot">1</div><div>{{ _('–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ') }}</div></div>
      <div class="step"><div class="dot">2</div><div>{{ _('–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ') }}</div></div>
      <div class="step"><div class="dot">3</div><div>{{ _('–û–ø—ã—Ç –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è') }}</div></div>
      <div class="step"><div class="dot">4</div><div>{{ _('–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ') }}</div></div>
      <div class="step"><div class="dot">5</div><div>{{ _('–í—Å–µ –ø–æ–ª—è') }}</div></div>
    </div>

    <div class="content-modal">
      <!-- STEP 1 -->
      <section class="pane" data-step="0">
        <div class="grid">
          <label class="field"><span>{{ _('–§–ò–û') }}</span><input id="f_full_name" readonly></label>
          <label class="field"><span>{{ _('–ó–∞–Ω–∏–º–∞–µ–º–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å') }}</span><input id="f_position" readonly></label>
          <label class="field"><span>{{ _('–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è') }}</span><input id="f_birth_date" readonly></label>
          <label class="field"><span>{{ _('–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏') }}</span><input id="f_created_at" readonly></label>
          <label class="field"><span>{{ _('–ö–æ–Ω—Ç–∞–∫—Ç—ã') }}</span><input id="f_contacts" readonly></label>
          <label class="field"><span>{{ _('–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞') }}</span><input id="f_email" readonly></label>
          <label class="field" style="grid-column:1/-1"><span>{{ _('–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è') }}</span><input id="f_address" readonly></label>
        </div>
      </section>

      <!-- STEP 2 -->
      <section class="pane" data-step="1" hidden>
        <div class="grid">
          <label class="field"><span>{{ _('–£—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ') }}</span><input id="f_education_institution" readonly></label>
          <label class="field"><span>{{ _('–ì–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è') }}</span><input id="f_graduation_year" readonly></label>
          <label class="field"><span>{{ _('–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ') }}</span><input id="f_specialization" readonly></label>
        </div>
      </section>

      <!-- STEP 3 -->
      <section class="pane" data-step="2" hidden>
        <div class="grid">
          <label class="field"><span>{{ _('–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –æ–ø—ã—Ç –ª–∏–¥–µ—Ä—Å—Ç–≤–∞...') }}</span><textarea id="f_leadership_experience" readonly></textarea></label>
          <label class="field"><span>{{ _('–ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞...') }}</span><textarea id="f_leader_skills" readonly></textarea></label>
          <label class="field"><span>{{ _('–ö–∞–∫–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è...') }}</span><textarea id="f_personal_achievements" readonly></textarea></label>
          <label class="field"><span>{{ _('–ö–∞–∫ –≤—ã –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç–µ –∫–æ–º–∞–Ω–¥—É...') }}</span><textarea id="f_motivation" readonly></textarea></label>
        </div>
      </section>

      <!-- STEP 4 -->
      <section class="pane" data-step="3" hidden>
        <div class="grid">
          <label class="field"><span>{{ _('–°–ª–æ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ') }}</span><textarea id="f_decision_case" readonly></textarea></label>
          <label class="field"><span>{{ _('–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã') }}</span><textarea id="f_conflict_resolution" readonly></textarea></label>
          <label class="field"><span>{{ _('–¶–µ–ª–∏ –Ω–∞ 3‚Äì5 –ª–µ—Ç') }}</span><textarea id="f_goals" readonly></textarea></label>
          <label class="field"><span>{{ _('–ö–∞–∫ –∫–æ–Ω–∫—É—Ä—Å –ø–æ–º–æ–∂–µ—Ç') }}</span><textarea id="f_contest_benefit" readonly></textarea></label>
          <label class="field"><span>{{ _('–ß—Ç–æ –∑–Ω–∞—á–∏—Ç –±—ã—Ç—å –ª–∏–¥–µ—Ä–æ–º') }}</span><textarea id="f_leader_definition" readonly></textarea></label>
          <label class="field"><span>{{ _('–ü–æ—á–µ–º—É —É—á–∞—Å—Ç–≤—É–µ—Ç–µ') }}</span><textarea id="f_reason" readonly></textarea></label>
          <label class="field"><span>{{ _('–û–ø—ã—Ç —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–∞—Ö') }}</span><textarea id="f_similar_experience" readonly></textarea></label>
        </div>
      </section>

      <!-- STEP 5 -->
      <section class="pane" data-step="4" hidden>
        <div class="kv-toolbar">
          <input id="kvSearch" class="kv-search" placeholder="{{ _('–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—è–º') }}">
          <label class="chk"><input type="checkbox" id="kvShowEmpty"> {{ _('–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ') }}</label>
          <label class="chk"><input type="checkbox" id="kvCollapseLong" checked> {{ _('–°–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ') }}</label>
        </div>
        <div class="kv-grid" id="kvGrid"></div>
      </section>
    </div>

    <div class="row-end">
      <div class="nav-buttons">
        <button class="btn-ghost" type="button" id="prevStepBtn" hidden>{{ _('–ù–∞–∑–∞–¥') }}</button>
        <button class="btn-primary" type="button" id="nextStepBtn">{{ _('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å') }}</button>
      </div>
      <div class="decision">
        <input id="decisionReason" class="reason-input" placeholder="{{ _('–ü—Ä–∏—á–∏–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)') }}">
        <button class="btn-ghost" type="button" id="approveBtn">‚úÖ {{ _('–û–¥–æ–±—Ä–∏—Ç—å') }}</button>
        <button class="btn-danger" type="button" id="rejectBtn">‚õî {{ _('–û—Ç–∫–ª–æ–Ω–∏—Ç—å') }}</button>
        <span id="decisionLockNote" class="muted" hidden></span>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRM -->
<div id="confirmOverlay" class="overlay overlay--confirm" aria-hidden="true">
  <div class="modal modal-confirm" role="dialog" aria-modal="true" aria-labelledby="cTitle">
    <div class="m-head">
      <div class="m-title" id="cTitle">{{ _('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ') }}</div>
      <button class="m-close" type="button" data-close-confirm>√ó</button>
    </div>
    <div class="content-modal" style="padding:16px">
      <p id="confirmText" style="margin:0"></p>
    </div>
    <div class="row-end" style="justify-content:flex-end">
      <button class="btn-ghost" type="button" id="confirmNo">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
      <button class="btn-primary" type="button" id="confirmYes">{{ _('–î–∞') }}</button>
    </div>
  </div>
</div>

<script>
  // –ö–Ω–æ–ø–∫–∏ —Ä–µ—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —Å–Ω–∞—Ä—É–∂–∏
  const approveBtn = document.getElementById('approveBtn');
  const rejectBtn  = document.getElementById('rejectBtn');
  const reasonInput = document.getElementById('decisionReason');
  const DECIDE_URL_TPL = "{{ url_for('admin.admin_decide', app_id='__ID__') }}";

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ª–æ–≥–≥–µ—Ä—ã –æ—à–∏–±–æ–∫ (—É–¥–æ–±–Ω–æ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ)
  window.addEventListener('error', e => console.error('JS error:', e.error || e.message));
  window.addEventListener('unhandledrejection', e => console.error('Unhandled promise:', e.reason));

(function(){
  const overlay = document.getElementById('detailsOverlay');
  const closeBtns = overlay.querySelectorAll('[data-close]');
  const panes = [...overlay.querySelectorAll('.pane')];
  const steps = [...overlay.querySelectorAll('.stepper .step')];

  const prevBtn = document.getElementById('prevStepBtn');
  const nextBtn = document.getElementById('nextStepBtn');

  const TXT_DONE = "{{ _('–ì–æ—Ç–æ–≤–æ') }}";
  const TXT_NEXT = "{{ _('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å') }}";
  const TXT_ERR = {
    net: "{{ _('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏') }}",
    need_reason: "{{ _('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è') }}",
    bad_status: "{{ _('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å') }}"
  };
  const L_OK  = "{{ _('–û–¥–æ–±—Ä–µ–Ω–æ') }}";
  const L_BAD = "{{ _('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') }}";

  function codeToLabel(code){
    if (code === 'approved') return L_OK;
    if (code === 'rejected') return L_BAD;
    return code || '';
  }

  let current = 0;
  let currentAppId = null;

  function updateNav(){
    prevBtn.hidden = (current === 0);
    const last = (current === panes.length - 1);
    nextBtn.textContent = last ? TXT_DONE : TXT_NEXT;
  }
  function showStep(i){
    panes.forEach((p,idx)=> p.hidden = idx!==i);
    steps.forEach((s,idx)=>{ s.classList.toggle('active', idx===i); s.classList.toggle('done', idx<i); });
    current = i; updateNav();
  }
  function openModal(appId){
    currentAppId = appId;
    reasonInput.value = '';
    overlay.classList.add('open'); document.body.style.overflow='hidden';
    showStep(0);
  }
  function closeModal(){ overlay.classList.remove('open'); document.body.style.overflow=''; currentAppId = null; }

  nextBtn.addEventListener('click', ()=>{ if (current < panes.length - 1) showStep(current + 1); else closeModal(); });
  prevBtn.addEventListener('click', ()=>{ if (current > 0) showStep(current - 1); });
  overlay.addEventListener('click', e=>{ if(e.target===overlay) closeModal(); });
  closeBtns.forEach(b=> b.addEventListener('click', closeModal));

  function setVal(id, v){ const el = document.getElementById(id); if(el) el.value = (v ?? ''); }

  const LABELS = {
    full_name: "{{ _('–§–ò–û') }}",
    position: "{{ _('–ó–∞–Ω–∏–º–∞–µ–º–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å') }}",
    birth_date: "{{ _('–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è') }}",
    created_at: "{{ _('–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏') }}",
    contacts: "{{ _('–ö–æ–Ω—Ç–∞–∫—Ç—ã') }}",
    email: "{{ _('–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞') }}",
    address: "{{ _('–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è') }}",
    education_institution: "{{ _('–£—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ') }}",
    graduation_year: "{{ _('–ì–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è') }}",
    specialization: "{{ _('–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ') }}",
    leadership_experience: "{{ _('–û–ø—ã—Ç –ª–∏–¥–µ—Ä—Å—Ç–≤–∞') }}",
    leader_skills: "{{ _('–ù–∞–≤—ã–∫–∏ –ª–∏–¥–µ—Ä–∞') }}",
    personal_achievements: "{{ _('–õ–∏—á–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è') }}",
    motivation: "{{ _('–ö–∞–∫ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç–µ –∫–æ–º–∞–Ω–¥—É') }}",
    decision_case: "{{ _('–°–ª–æ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ') }}",
    conflict_resolution: "{{ _('–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã') }}",
    goals: "{{ _('–¶–µ–ª–∏ –Ω–∞ 3‚Äì5 –ª–µ—Ç') }}",
    contest_benefit: "{{ _('–ö–∞–∫ –∫–æ–Ω–∫—É—Ä—Å –ø–æ–º–æ–∂–µ—Ç') }}",
    leader_definition: "{{ _('–ß—Ç–æ –∑–Ω–∞—á–∏—Ç –±—ã—Ç—å –ª–∏–¥–µ—Ä–æ–º') }}",
    reason: "{{ _('–ü–æ—á–µ–º—É —É—á–∞—Å—Ç–≤—É–µ—Ç–µ') }}",
    similar_experience: "{{ _('–û–ø—ã—Ç —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–∞—Ö') }}",
    test_status: "{{ _('–°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∞') }}",
    test_score: "{{ _('–ë–∞–ª–ª—ã –∑–∞ —Ç–µ—Å—Ç') }}",
    test_total: "{{ _('–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤') }}",
    test_percent: "{{ _('–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö, %') }}",
    test_link: "{{ _('–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ') }}"
  };

  const KV_EXCLUDE = new Set(['id', 'consent']);

  const kvGrid = document.getElementById('kvGrid');
  const kvSearch = document.getElementById('kvSearch');
  const kvShowEmpty = document.getElementById('kvShowEmpty');
  const kvCollapseLong = document.getElementById('kvCollapseLong');

  function makeKvItem(labelText, rawVal){
    const wrap = document.createElement('div'); wrap.className = 'kv-item';
    const label = document.createElement('div'); label.className='kv-label'; label.textContent = labelText;

    const s = String(rawVal ?? '').trim();
    const isUrl = /^https?:\/\/\S+$/i.test(s);

    const value = document.createElement('div'); value.className='kv-value';
    if (kvCollapseLong.checked) value.classList.add('collapsed');

    if (!s){
      const badge = document.createElement('span'); badge.className='kv-empty'; badge.textContent='{{ _("–ü—É—Å—Ç–æ") }}';
      value.appendChild(badge);
    } else if (isUrl){
      const a = document.createElement('a');
      a.href = s; a.target = '_blank'; a.rel = 'noopener';
      a.textContent = s;
      value.appendChild(a);
    } else {
      value.textContent = s;
    }

    const actions = document.createElement('div'); actions.className='kv-actions';
    const copyBtn = document.createElement('button'); copyBtn.type='button'; copyBtn.className='kv-copy'; copyBtn.textContent='{{ _("–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å") }}';
    copyBtn.addEventListener('click', ()=> {
      navigator.clipboard.writeText(s);
      const old = copyBtn.textContent; copyBtn.textContent='{{ _("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!") }}'; setTimeout(()=>copyBtn.textContent=old, 1200);
    });

    const toggleBtn = document.createElement('button'); toggleBtn.type='button'; toggleBtn.className='kv-toggle';
    toggleBtn.textContent = value.classList.contains('collapsed') ? '{{ _("–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å") }}' : '{{ _("–°–≤–µ—Ä–Ω—É—Ç—å") }}';
    toggleBtn.addEventListener('click', ()=> {
      value.classList.toggle('collapsed');
      toggleBtn.textContent = value.classList.contains('collapsed') ? '{{ _("–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å") }}' : '{{ _("–°–≤–µ—Ä–Ω—É—Ç—å") }}';
    });

    if (isUrl){
      const openA = document.createElement('a');
      openA.href = s; openA.target = '_blank'; openA.rel = 'noopener';
      openA.className = 'kv-copy'; openA.textContent = '{{ _("–û—Ç–∫—Ä—ã—Ç—å") }}';
      actions.append(openA);
    }

    actions.append(copyBtn, toggleBtn);
    wrap.append(label, value, actions);
    return wrap;
  }

  let kvData = []; // [{k,label,val},...]

  function renderKv(){
    const q = (kvSearch.value || '').trim().toLowerCase();
    kvGrid.innerHTML = '';
    kvData.forEach(it => {
      const isEmpty = (it.val ?? '') === '';
      if (!kvShowEmpty.checked && isEmpty) return;
      if (q && !(it.label.toLowerCase().includes(q) || String(it.val||'').toLowerCase().includes(q))) return;
      kvGrid.appendChild(makeKvItem(it.label, it.val));
    });
  }

  kvSearch && kvSearch.addEventListener('input', renderKv);
  kvShowEmpty && kvShowEmpty.addEventListener('change', renderKv);
  kvCollapseLong && kvCollapseLong.addEventListener('change', renderKv);

  function fillKvList(formObj, meta){
    const base = { id: meta.id, email: meta.email, full_name: meta.full_name, created_at: (meta.created_at || '').slice(0,10) };
    const merged = {...base, ...formObj};

    const knownOrder = Object.keys(LABELS);
    const entries = Object.entries(merged)
      .filter(([k]) => !KV_EXCLUDE.has(k))
      .map(([k,v])=>({k, val: (typeof v==='object' && v!==null) ? JSON.stringify(v, null, 2) : v, label: LABELS[k] || k}));
    entries.sort((a,b)=>{
      const ia = Math.max(knownOrder.indexOf(a.k), -1); const ib = Math.max(knownOrder.indexOf(b.k), -1);
      const pa = ia === -1 ? 9999 : ia; const pb = ib === -1 ? 9999 : ib;
      return pa - pb || a.k.localeCompare(b.k);
    });

    kvData = entries;
    renderKv();
  }

  async function loadDetails(appId){
    const url = "{{ url_for('admin.admin_app_json', app_id='__ID__') }}".replace('__ID__', appId);
    const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!r.ok) throw new Error('HTTP ' + r.status);

    let j;
    try { j = await r.json(); } catch { throw new Error('Bad JSON from ' + url); }

    // helpers back
    const f = j.form || {};
    const get = k => (f[k] ?? '');
    const getDate = (v) => {
      if (!v) return '';
      if (typeof v === 'string') return v.slice(0,10);
      try { return new Date(v).toISOString().slice(0,10); } catch { return ''; }
    };

    // step 1
    setVal('f_full_name',  j.full_name || get('full_name'));
    setVal('f_email',      j.email || get('email'));
    setVal('f_created_at', getDate(j.created_at || get('created_at')));
    setVal('f_position',   get('position'));
    setVal('f_birth_date', get('birth_date'));
    setVal('f_contacts',   get('contacts'));
    setVal('f_address',    get('address'));

    // step 2
    setVal('f_education_institution', get('education_institution'));
    setVal('f_graduation_year',       get('graduation_year'));
    setVal('f_specialization',        get('specialization'));

    // step 3
    setVal('f_leadership_experience',  get('leadership_experience'));
    setVal('f_leader_skills',          get('leader_skills'));
    setVal('f_personal_achievements',  get('personal_achievements'));
    setVal('f_motivation',             get('motivation'));

    // step 4
    setVal('f_decision_case',       get('decision_case'));
    setVal('f_conflict_resolution', get('conflict_resolution'));
    setVal('f_goals',               get('goals'));
    setVal('f_contest_benefit',     get('contest_benefit'));
    setVal('f_reason',              get('reason'));
    setVal('f_leader_definition',   get('leader_definition'));
    setVal('f_similar_experience',  get('similar_experience'));

    // step 5: —Ç–µ—Å—Ç
    const t = j.test || null;
    const passed =
      (t && typeof t.passed !== 'undefined') ? t.passed :
      (typeof j.test_passed !== 'undefined' ? j.test_passed : null);

    const testFields = {};
    if (t || j.test_score != null) {
      testFields.test_status   = (passed === true) ? "{{ _('–ü—Ä–æ–π–¥–µ–Ω') }}" : "{{ _('–ù–µ –ø—Ä–æ–π–¥–µ–Ω') }}";
      testFields.test_score    = (t && t.score)   ?? j.test_score   ?? null;
      testFields.test_total    = (t && t.total)   ?? j.test_total   ?? null;
      testFields.test_percent  = (t && t.percent) ?? j.test_percent ?? null;
    }

    async function decide(status){
      if (!currentAppId) return;
      if (approveBtn.disabled && rejectBtn.disabled) return;

      const reason = (reasonInput.value || '').trim();
      if (status === 'rejected' && !reason){
        alert(TXT_ERR.need_reason);
        return;
      }

      approveBtn.disabled = true;
      rejectBtn.disabled  = true;

      try{
        const url = DECIDE_URL_TPL.replace('__ID__', currentAppId);
        const r = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ status, reason })
        });
        const j = await r.json();

        if (!r.ok || !j.ok){
          if (j.error === 'already_decided'){
            lockDecisionUI(true, j.status_label || codeToLabel(j.status || j.status_code || ''));
            alert('{{ _("–†–µ—à–µ–Ω–∏–µ –ø–æ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–æ.") }}');
            return;
          }
          alert(j.error === 'need_reason' ? TXT_ERR.need_reason :
                j.error === 'bad_status' ? TXT_ERR.bad_status : TXT_ERR.net);
          approveBtn.disabled = false;
          rejectBtn.disabled  = false;
          return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —á–∏–ø –≤ —Å–ø–∏—Å–∫–µ
        const rowBtn = document.querySelector(`.details-btn[data-id="${currentAppId}"]`);
        if (rowBtn){
          const right = rowBtn.closest('.right');
          let chip = right.querySelector('.chip-status');
          if (!chip){
            chip = document.createElement('span');
            chip.className = 'chip chip--status chip-status';
            right.insertBefore(chip, rowBtn);
          }
          const code  = j.status_code
                     || (j.status === L_OK ? 'approved'
                         : (j.status === L_BAD ? 'rejected' : ''));
          const label = j.status_label || codeToLabel(code) || (j.status || '');

          chip.textContent = label;
          chip.classList.toggle('ok',  code === 'approved');
          chip.classList.toggle('bad', code === 'rejected');

          lockDecisionUI(true, label);
        }

        closeModal();

      } catch(e){
        console.error(e);
        alert(TXT_ERR.net);
        approveBtn.disabled = false;
        rejectBtn.disabled  = false;
      }
    }
    window.decide = decide;

    // –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω)
    const link =
      (t && (t.link || t.video_link)) ??
      j.test_link ??
      j.video_link ?? null;
    if (passed === true && link) testFields.test_link = link;

    const f2 = { ...f, ...testFields };
    fillKvList(f2, { id:j.id, email:j.email, full_name:j.full_name, created_at:j.created_at });
    applyDecisionLockFromPayload(j);
  }

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–∞ –ø–æ ¬´–î–µ—Ç–∞–ª–∏¬ª
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.details-btn');
    if (!btn) return;

    const appId = btn.dataset.id;
    openModal(appId);

    try {
      await loadDetails(appId);
    } catch (err) {
      console.error('loadDetails failed:', err);
      alert('{{ _("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏") }}');
    }
  });

})(); // –∫–æ–Ω–µ—Ü IIFE

// vh fix
(function(){ function setVh(){ document.documentElement.style.setProperty('--vh', window.innerHeight*0.01 + 'px'); } setVh(); window.addEventListener('resize', setVh); })();

// lang menu
(function(){
  const sw = document.getElementById('langSwitch'); if(!sw) return;
  const btn = sw.querySelector('.btn-lang');
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); sw.classList.toggle('open'); btn.setAttribute('aria-expanded', sw.classList.contains('open')); });
  document.addEventListener('click', ()=> sw.classList.remove('open'));
})();

// user menu
(function(){
  const sw = document.getElementById('userSwitch');
  if(!sw) return;
  const btn = sw.querySelector('.user-btn');
  function close(){ sw.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = sw.classList.toggle('open');
    btn.setAttribute('aria-expanded', String(open));
  });
  document.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();

/* ===== –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ + –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è ===== */
const confirmBox      = document.getElementById('confirmOverlay');
const confirmText     = document.getElementById('confirmText');
const confirmYes      = document.getElementById('confirmYes');
const confirmNo       = document.getElementById('confirmNo');
const confirmCloseBtn = confirmBox ? confirmBox.querySelector('[data-close-confirm]') : null;

const lockNote = document.getElementById('decisionLockNote');
let pendingAction = null;

function openConfirm(action){
  if (action === 'rejected') {
    const reason = (reasonInput.value || '').trim();
    if (!reason) {
      alert("{{ _('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è') }}");
      reasonInput.focus();
      return;
    }
  }
  pendingAction = action;

  if (action === 'approved') {
    confirmText.textContent = "{{ _('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?') }}";
    confirmYes.textContent  = "{{ _('–û–¥–æ–±—Ä–∏—Ç—å') }}";
    confirmYes.classList.remove('btn-danger');
    confirmYes.classList.add('btn-primary');
  } else {
    confirmText.textContent = "{{ _('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?') }}";
    confirmYes.textContent  = "{{ _('–û—Ç–∫–ª–æ–Ω–∏—Ç—å') }}";
    confirmYes.classList.remove('btn-primary');
    confirmYes.classList.add('btn-danger');
  }

  confirmBox.classList.add('open');
}
function closeConfirm(){
  confirmBox.classList.remove('open');
  pendingAction = null;
}
function lockDecisionUI(decided, statusText){
  approveBtn.disabled  = !!decided;
  rejectBtn.disabled   = !!decided;
  reasonInput.disabled = !!decided;
  lockNote.hidden = !decided;
  lockNote.textContent = decided ? ('{{ _("–†–µ—à–µ–Ω–∏–µ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–æ:") }} ' + (statusText || '')) : '';
}

approveBtn.addEventListener('click', ()=>{
  if (approveBtn.disabled) return;
  openConfirm('approved');
});
rejectBtn.addEventListener('click', ()=>{
  if (rejectBtn.disabled) return;
  openConfirm('rejected');
});

confirmYes.addEventListener('click', ()=>{
  const act = pendingAction;
  closeConfirm();
  if (act) decide(act);
});
confirmNo.addEventListener('click', closeConfirm);
confirmCloseBtn && confirmCloseBtn.addEventListener('click', closeConfirm);

function applyDecisionLockFromPayload(j){
  const code  = j.status || j.commission_status || '';
  const label = j.status_label || (code ? (code === 'approved' || code === 'rejected' ? (code==='approved' ? "{{ _('–û–¥–æ–±—Ä–µ–Ω–æ') }}" : "{{ _('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') }}") : code) : '');
  lockDecisionUI(!!code, label);
}
</script>

</body>
</html>
