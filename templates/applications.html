{% extends "base.html" %}
{% block title %}{{ _('Мои заявки') }} · {{ _('Лидеры года') }}{% endblock %}

{% block extra_head %}
<style>
  .apps {max-width: 980px; margin: 0 auto;}
  .app-card{
    background:#f7f7f7; border:1px solid #eee; border-radius:12px;
    padding:16px 18px; margin:14px 0; box-shadow:0 2px 4px rgba(0,0,0,.03);
  }
  .app-title{font-weight:600; margin:4px 0 10px; color:#111827}
  .app-desc{display:flex; align-items:center; gap:8px; color:#64748b; font-size:14px; margin:0 0 8px}
  .app-reason{color:#0f172a; font-size:14px; margin:6px 0 0}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot-green{background:#22c55e}
  .dot-red{background:#ef4444}
  .dot-gray{background:#94a3b8}
  .divider{height:2px; background:#e5e7eb; border-radius:2px; margin-top:8px}
  .empty{background:#fff; border:1px dashed #e5e7eb; border-radius:12px; padding:18px; text-align:center; color:#6b7280}

  .btn-go-tests{
    display:inline-block; padding:10px 14px; border-radius:10px;
    background:linear-gradient(90deg,#2e7d32,#1b5e20); color:#fff;
    text-decoration:none; font-weight:600; font-size:14px;
  }
  .btn-go-tests:hover{ opacity:.92; }

  .link-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:12px}
  .link-label{font-weight:600;margin-right:6px}
  .link-input{flex:1 1 260px;min-width:240px;max-width:520px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
  .btn-small{padding:8px 12px;border-radius:8px;font-weight:600}
</style>
{% endblock %}

{% block content %}
<div class="apps">

  {# последняя заявка #}
  {% set latest = (items[0] if items and items|length > 0 else None) %}
  {% set latest_status = latest['commission_status'] if latest else None %}
  {% set latest_comment = latest['commission_comment'] if latest else None %}
  {% set is_approved = (latest_status == 'approved') or (latest_status and ((latest_status|lower)[:4] == 'одобр')) %}
  {% set is_rejected = (latest_status == 'rejected') or (latest_status and ((latest_status|lower)[:4] == 'откл')) %}

  <div id="statusBanner"
       class="alert {{ 'alert-success' if is_approved else ('alert-error' if is_rejected else '') }}"
       style="{{ '' if latest_status else 'display:none;' }} margin-top:12px;">
    {% if latest_status %}
      <strong>{{ _('Одобрено') if latest_status=='approved' else (_('Отклонено') if latest_status=='rejected' else latest_status) }}</strong>
      {% if latest_comment %} — {{ latest_comment }}{% endif %}
    {% endif %}
  </div>

  {% if items and items|length > 0 %}
    {% for it in items %}
      {% set app_id = it['id'] %}
      {% set status = it['commission_status'] %}
      {% set comment = it['commission_comment'] %}
      {% set ok  = (status == 'approved') or (status and ((status|string|lower)[:5] == 'одобр')) %}
      {% set bad = (status == 'rejected') or (status and ((status|string|lower)[:4] == 'откл')) %}
      {% set dot = 'dot-green' if ok else ('dot-red' if bad else 'dot-gray') %}

      <div class="app-card" data-app-id="{{ app_id }}">
        <div class="app-title">{{ _('Заявка №') }} {{ it.public_no or loop.index }}</div>
        <p class="app-desc">
          <span class="dot {{ dot }}" id="dot-{{ app_id }}"></span>
          <span id="statusText-{{ app_id }}">
            {% if not status %}
              {{ _('Ожидайте ответ в течение нескольких дней на почту') }}
            {% elif ok %}
              {{ _('Одобрено комиссией — проверьте почту, там ссылка на тест') }}
            {% elif bad %}
              {{ _('К сожалению, отклонено. Подробности в письме на почте') }}
            {% else %}
              {{ _('Статус:') }} {{ status }}
            {% endif %}
          </span>
        </p>

        <p class="app-reason" id="reason-{{ app_id }}" {% if not comment %}style="display:none"{% endif %}>
          {% if comment %}<strong>{{ _('Комментарий комиссии:') }}</strong> {{ comment }}{% endif %}
        </p>

        <div class="divider"></div>
      </div>
    {% endfor %}
  {% else %}
    <div class="empty">{{ _('У вас пока нет заявок.') }}</div>
  {% endif %}

  {% set has_approved = is_approved %}
  <div class="app-card" id="testCard">
    <div class="app-title">{{ _('Тест') }}</div>
    <p class="app-desc" style="justify-content:space-between; align-items:center;">
      <span style="display:flex; align-items:center; gap:8px;">
        <span class="dot {{ 'dot-green' if has_approved else 'dot-gray' }}" id="testDot"></span>
        <span id="testText">
          {% if has_approved %}
            {{ _('Вы допущены к тестированию. Можно перейти к тестам.') }}
          {% else %}
            {{ _('Ссылка на тест появится после одобрения вашей заявки') }}
          {% endif %}
        </span>
      </span>
      <a id="testBtn"
         href="{{ url_for('tests.tests') }}"
         class="btn-go-tests"
         {% if not has_approved %}style="display:none"{% endif %}>
        {{ _('Перейти к тестам') }}
      </a>
    </p>
    <div class="divider"></div>

    {% if test_passed and latest_app_id %}
      <form class="test-link-form"
            action="{{ url_for('main.save_test_link', app_id=latest_app_id) }}"
            method="POST" style="margin-top:4px">
        <div class="link-row">
          <label class="link-label">{{ _('Ваша ссылка на результат теста') }}:</label>
          <input class="link-input"
                 type="url"
                 name="test_link"
                 value="{{ test_link or '' }}"
                 placeholder="{{ _('Вставьте ссылку сюда (https://...)') }}"
                 required
                 pattern="https?://.+">
          <button type="submit" class="btn btn-small">{{ _('Сохранить') }}</button>
          {% if test_link %}
            <a class="btn btn-ghost btn-small" href="{{ test_link }}" target="_blank" rel="noopener">
              {{ _('Открыть') }}
            </a>
          {% endif %}
        </div>
        <p class="app-desc" style="margin:6px 0 0; color:#64748b; font-size:12px">
          {{ _('После прохождения теста вставьте сюда ссылку и нажмите «Сохранить».') }}
        </p>
      </form>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const API = "{{ url_for('main.api_my_application') }}";
  const banner = document.getElementById('statusBanner');
  const testDot = document.getElementById('testDot');
  const testText = document.getElementById('testText');
  const testBtn  = document.getElementById('testBtn');
  const LS_KEY = 'my_app_last_status_apps';

  function setDot(el, code){
    if(!el) return;
    el.classList.remove('dot-green','dot-red','dot-gray');
    const s = (code||'').toLowerCase();
    el.classList.add(s==='approved' ? 'dot-green' : (s==='rejected' ? 'dot-red' : 'dot-gray'));
  }
  function statusTextLocalized(codeOrText){
    if(!codeOrText) return "{{ _('Ожидайте ответ в течение нескольких дней на почту') }}";
    const s = (codeOrText+'').toLowerCase();
    if (s==='approved' || s.startsWith('одобр')) return "{{ _('Одобрено комиссией — проверьте почту, там ссылка на тест') }}";
    if (s==='rejected' || s.startsWith('откл')) return "{{ _('К сожалению, отклонено. Подробности в письме на почте') }}";
    return "{{ _('Статус:') }} " + codeOrText;
  }
  function renderBanner(code, comment){
    if(!banner) return;
    if(!code){ banner.style.display='none'; return; }
    const ok = (code.toLowerCase()==='approved') || code.toLowerCase().startsWith('одобр');
    const bad= (code.toLowerCase()==='rejected') || code.toLowerCase().startsWith('откл');
    banner.className = 'alert ' + (ok ? 'alert-success' : (bad ? 'alert-error' : ''));
    const label = ok ? "{{ _('Одобрено') }}" : (bad ? "{{ _('Отклонено') }}" : code);
    banner.innerHTML = '<strong>'+label+'</strong>' + (comment ? ' — ' + comment : '');
    banner.style.display = '';
  }
  function setTestCardByStatus(code){
    const s = (code||'').toLowerCase();
    const approved = (s==='approved') || s.startsWith('одобр');
    if(testDot) setDot(testDot, approved ? 'approved' : '');
    if(testText){
      testText.textContent = approved
        ? "{{ _('Вы допущены к тестированию. Можно перейти к тестам.') }}"
        : "{{ _('Ссылка на тест появится после одобрения вашей заявки') }}";
    }
    if(testBtn){
      testBtn.style.display = approved ? '' : 'none';
    }
  }

  async function poll(){
    try{
      const r = await fetch(API, {cache:'no-store'});
      if(!r.ok) return;
      const j = await r.json();
      if(!j.exists) return;

      const {id, status, comment} = j;

      renderBanner(status, comment);

      if (id){
        const card = document.querySelector('.app-card[data-app-id="'+id+'"]');
        if (card){
          const dot = card.querySelector('#dot-'+id);
          if (dot) {
            const s = (status||'').toLowerCase();
            dot.classList.remove('dot-green','dot-red','dot-gray');
            dot.classList.add(s==='approved' ? 'dot-green' : (s==='rejected' ? 'dot-red' : 'dot-gray'));
          }
          const st = card.querySelector('#statusText-'+id);
          if (st) st.textContent = statusTextLocalized(status);
          const rs = card.querySelector('#reason-'+id);
          if (rs){
            if (comment){
              rs.style.display = '';
              rs.innerHTML = '<strong>{{ _("Комментарий комиссии:") }}</strong> ' + comment;
            }else{
              rs.style.display = 'none';
              rs.textContent = '';
            }
          }
        }
      }

      setTestCardByStatus(status);

      const last = localStorage.getItem(LS_KEY) || '';
      if (status && status !== last){
        localStorage.setItem(LS_KEY, status);
      }
    }catch(e){}
  }

  poll();
  setInterval(poll, 20000);
})();
</script>
{% endblock %}
