<!doctype html>
<html lang="{{ get_locale() or 'ru' }}">
<head>
<meta charset="utf-8">
<title>{{ _('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ¬∑ –õ–∏–¥–µ—Ä—ã –≥–æ–¥–∞') }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--g:#1c7a45;--bg:#f6f7f8;--border:#e5e7eb;--muted:#64748b;--shadow:0 8px 30px rgba(0,0,0,.06);--green:#22c55e}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg)}
.layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}

/* aside */
.aside{background:var(--g);color:#fff;padding:16px 12px}
.brand{display:flex;align-items:center;gap:10px;padding:8px 10px;margin-bottom:14px}
.brand img{width:36px;height:36px;border-radius:50%}
.nav{display:flex;flex-direction:column;gap:6px}
.nav a{display:flex;align-items:center;gap:10px;color:#e8fbee;text-decoration:none;padding:10px 12px;border-radius:10px}
.nav a.active,.nav a:hover{background:#0e5935;color:#fff}

/* topbar */
.topbar{background:#fff;border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center;justify-content:space-between;gap:14px;padding:0 18px}
.topbar-right{display:flex;align-items:center;gap:12px}

.user-inline{display:flex;align-items:center;gap:10px}
.user-inline .who{display:flex;flex-direction:column;line-height:1.1;text-align:right}
.user-inline .name{font-size:14px;font-weight:600}
.user-inline .role{font-size:12px;color:#475569}
.user-inline .avatar{width:34px;height:34px;border-radius:50%;background:#e5f6ec;color:#1e824f;display:grid;place-items:center;font-weight:700}

/* language */
.lang-switch{position:relative}
.btn-lang{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;height:34px;cursor:pointer}
.btn-lang img{width:20px;height:20px;border-radius:50%}
.lang-menu{position:absolute;right:0;top:calc(100% + 8px);display:none;min-width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 30px rgba(2,6,23,.18);padding:6px;z-index:10}
.lang-switch.open .lang-menu{display:block}
.lang-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;color:#0f172a;text-decoration:none}
.lang-item:hover{background:#f8fafc}
.lang-item .check{margin-left:auto;color:var(--green);font-weight:700;opacity:0}
.lang-item.active .check{opacity:1}

/* user menu (logout) */
.user-switch{position:relative}
.user-btn{
  display:flex;align-items:center;gap:10px;
  background:#fff;border:1px solid #e5e7eb;border-radius:999px;
  padding:6px 10px;height:36px;cursor:pointer;
  box-shadow:0 10px 30px -18px rgba(0,0,0,.45), 0 1px 0 rgba(0,0,0,.04);
}
.user-btn .caret{font-size:12px;opacity:.7;transition:transform .2s ease,opacity .2s ease}
.user-switch.open .user-btn .caret{transform:rotate(180deg);opacity:1}
.user-menu{
  position:absolute;right:0;top:calc(100% + 8px);z-index:15;
  display:none;min-width:220px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;
  box-shadow:0 24px 60px rgba(2,6,23,.22);overflow:hidden;
  transform-origin:top right;transform:scale(.98);opacity:0;
  transition:transform .16s ease,opacity .16s ease;
}
.user-switch.open .user-menu{display:block;transform:scale(1);opacity:1}
.user-menu .menu-item,
.user-menu form button{
  width:100%;display:flex;align-items:center;gap:10px;
  padding:10px 12px;background:none;border:0;text-align:left;
  font:inherit;color:#111827;text-decoration:none;cursor:pointer;
}
.user-menu .menu-item:hover,
.user-menu form button:hover{background:#f3f4f6}
.user-menu .danger{color:#b91c1c}
.user-menu .danger:hover{background:#fee2e2}

/* content */
.content{padding:18px 22px}
.h1{font-size:20px;font-weight:700;margin:8px 0 16px;display:flex;align-items:center;gap:12px}
.btn{border:none;background:var(--green);color:#fff;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:12px 14px}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{padding:10px 12px;border-top:1px solid #eef1f4;vertical-align:middle;font-size:14px}
.table thead th{border-top:none;color:#0f172a;font-weight:700;background:#fafafa}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
.badge.ok{background:#e8f7ef;color:#0b7a45}
.badge.off{background:#f1f5f9;color:#475569}

/* row actions */
.kebab{position:relative}
.kebab-btn{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;cursor:pointer}
.kebab-menu{position:absolute;right:0;top:calc(100% + 6px);display:none;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 30px rgba(2,6,23,.18);min-width:160px;overflow:hidden;z-index:5}
.kebab.open .kebab-menu{display:block}
.kebab-menu a,.kebab-menu button{display:block;width:100%;padding:9px 12px;background:#fff;border:0;text-align:left;cursor:pointer}
.kebab-menu a:hover,.kebab-menu button:hover{background:#f8fafc}
.kebab-menu .danger{color:#b91c1c}

/* modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;z-index:1000}
.overlay.open{display:grid}
.modal{width:min(760px,94vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 20px 60px rgba(2,6,23,.18);overflow:hidden}
.m-head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border)}
.m-title{font-weight:700}
.m-close{appearance:none;border:none;background:transparent;font-size:22px;cursor:pointer}
.m-body{padding:16px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
.field input,.field select{padding:10px;border:1px solid var(--border);border-radius:8px;background:#f9fafb}
.m-foot{padding:12px 16px;border-top:1px solid var(--border);background:#fafafa;display:flex;gap:8px;justify-content:flex-end}
@media (max-width:640px){.grid{grid-template-columns:1fr}}

  /* —Ñ–∏–∫—Å —Ä–∞–∑–º–µ—Ä–æ–≤ —Ñ–ª–∞–≥–æ–≤ –≤ –º–µ–Ω—é —è–∑—ã–∫–æ–≤ */
.lang-menu img,
.lang-item img{
  width:20px;
  height:20px;
  border-radius:50%;
  flex:0 0 20px; /* —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∏—Å—å */
}
.lang-item{ font-size:14px; line-height:1.1; }

</style>
</head>
<body>
<div class="layout">
  <!-- aside -->
  <aside class="aside">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="">
      <strong>{{ _('–õ–∏–¥–µ—Ä—ã –≥–æ–¥–∞') }}</strong>
    </div>
    <nav class="nav">
  <a class="active" href="{{ url_for('prov.dashboard') }}">üë• {{ _('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') }}</a>
  <a href="{{ url_for('prov.commission_logs_page') }}">üìú {{ _('–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–∏—Å—Å–∏–∏') }}</a>
</nav>

  </aside>

  <!-- main -->
  <div>
    <header class="topbar">
      <div></div>
      <div class="topbar-right">
        {% set cur = (get_locale() or 'ru') %}
        {% set flags = {
          'ru': url_for('static', filename='ru.png'),
          'ky': url_for('static', filename='ky.png')
        } %}

        <!-- Language -->
        <div class="lang-switch" id="langSwitch">
          <button class="btn-lang" type="button">
            <img src="{{ flags[cur] }}" alt="">
            {{ '–†—É—Å—Å–∫–∏–π' if cur=='ru' else '–ö—ã—Ä–≥—ã–∑—á–∞' }} <span class="caret">‚ñæ</span>
          </button>
          <div class="lang-menu">
            <a class="lang-item {{ 'active' if cur=='ru' else '' }}" href="{{ url_for('set_locale', lang='ru', next=request.full_path) }}">
              <img src="{{ flags['ru'] }}" alt=""><span>–†—É—Å—Å–∫–∏–π</span><span class="check">‚úì</span>
            </a>
            <a class="lang-item {{ 'active' if cur=='ky' else '' }}" href="{{ url_for('set_locale', lang='ky', next=request.full_path) }}">
              <img src="{{ flags['ky'] }}" alt=""><span>–ö—ã—Ä–≥—ã–∑—á–∞</span><span class="check">‚úì</span>
            </a>
          </div>
        </div>

        <!-- User + logout -->
        <div class="user-switch" id="userSwitch">
          <button class="user-btn" type="button" aria-haspopup="true" aria-expanded="false">
            <div class="user-inline">
              <div class="who">
                <div class="name">{{ session.get('user_email') or '‚Äî' }}</div>
                <div class="role">{{ _('–°—É–ø–µ—Ä –∞–¥–º–∏–Ω') }}</div>
              </div>
              <div class="avatar">{{ (session.get('user_email','A')[0]|upper) }}</div>
            </div>
            <span class="caret">‚ñæ</span>
          </button>
          <div class="user-menu" role="menu" aria-label="{{ _('–ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è') }}">
            <form action="{{ url_for('auth.logout') }}" method="post">
              {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
              <button type="submit" class="danger">üö™ {{ _('–í—ã–π—Ç–∏') }}</button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <main class="content">
      <div class="h1">
        <span>{{ _('–°–ø–∏—Å–æ–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤') }}</span>
        <button class="btn" id="openCreate">{{ _('+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è') }}</button>
      </div>

      <div class="card">
        {% if not users %}
          <div style="padding:24px;text-align:center;color:#64748b">{{ _('–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç') }}</div>
        {% else %}
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>‚Ññ</th>
                  <th>{{ _('–§–ò–û') }}</th>
                  <th>{{ _('–î–æ–ª–∂–Ω–æ—Å—Ç—å') }}</th>
                  <th>{{ _('–ò–ù–ù') }}</th>
                  <th>{{ _('–ü–æ—á—Ç–∞') }}</th>
                  <th>{{ _('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞') }}</th>
                  <th>{{ _('–í—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–∞') }}</th>
                  <th>{{ _('–î–∞—Ç–∞') }}</th>
                  <th>{{ _('–°—Ç–∞—Ç—É—Å') }}</th>
                  <th class="text-end">{{ _('–î–µ–π—Å—Ç–≤–∏–µ') }}</th>
                </tr>
              </thead>
              <tbody>
              {% for u in users %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ u.full_name or '‚Äî' }}</td>
                  <td>{{ u.position or '‚Äî' }}</td>
                  <td>{{ u.inn or '‚Äî' }}</td>
                  <td>{{ u.email }}</td>
                  <td>{{ u.phone or '‚Äî' }}</td>
                  <td>{{ (u.access_expires_at.isoformat()[:10] ~ ' ' ~ (u.access_expires_at.isoformat()[11:16] if u.access_expires_at else '')) if u.access_expires_at else '‚Äî' }}</td>
                  <td>{{ u.created_at.strftime('%d.%m.%y') if u.created_at else '‚Äî' }}</td>
                  <td>
                    {% if u.is_active %}<span class="badge ok">{{ _('–ê–∫—Ç–∏–≤–µ–Ω') }}</span>
                    {% else %}<span class="badge off">{{ _('–û—Ç–∫–ª—é—á—ë–Ω') }}</span>{% endif %}
                  </td>
                  <td>
                    <div class="kebab" data-id="{{ u.id }}">
                      <button class="kebab-btn" type="button">‚ãÆ</button>
                      <div class="kebab-menu">
                        <button class="js-extend" type="button">{{ _('–ò–∑–º–µ–Ω–∏—Ç—å') }}</button>
                        <button class="danger js-delete" type="button">{{ _('–£–¥–∞–ª–∏—Ç—å') }}</button>
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </main>
  </div>
</div>

<!-- CREATE MODAL -->
<div class="overlay" id="createOverlay" aria-hidden="true">
  <form class="modal" method="post" action="{{ url_for('prov.create_internal_user') }}">
    <div class="m-head">
      <div class="m-title">{{ _('–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞)') }}</div>
      <button class="m-close" type="button" data-close>√ó</button>
    </div>
    <div class="m-body">
      <div class="grid">
        <label class="field">
          <span>{{ _('–§–ò–û') }}</span>
          <input name="full_name" required>
        </label>
        <label class="field">
  <span>{{ _('–ò–ù–ù') }}</span>
  <input name="inn" id="innInput" required
         inputmode="numeric" minlength="14" maxlength="14"
         pattern="\d{14}" placeholder="14 —Ü–∏—Ñ—Ä">
</label>

<label class="field">
  <span>{{ _('–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ') }}</span>
  <input name="phone" id="kgPhone" required
         inputmode="tel"
         placeholder="+996 (XXX) XXX-XXX"
         pattern="^\+996\s?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{3}$">
</label>
        <label class="field">
          <span>{{ _('–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞') }}</span>
          <input name="email" type="email" required>
        </label>
        <label class="field">
          <span>{{ _('–ü–∞—Ä–æ–ª—å') }}</span>
          <input name="password" type="password" minlength="12" required>
        </label>
        <label class="field">
          <span>{{ _('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å') }}</span>
          <input name="password2" type="password" minlength="12" required>
        </label>
        <label class="field">
          <span>{{ _('–í—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–∞') }}</span>
          <input name="access_until" type="datetime-local" required>
        </label>
        <label class="field">
          <span>{{ _('–î–æ–ª–∂–Ω–æ—Å—Ç—å') }}</span>
          <input name="position" placeholder="{{ _('–ö—ã–∑ –¥–µ–º–∏') }}">
        </label>
      </div>
    </div>
    <div class="m-foot">
      <button class="btn" type="submit">{{ _('–°–æ–∑–¥–∞—Ç—å') }}</button>
      <button class="btn" type="button" data-close style="background:#e5e7eb;color:#111">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
    </div>
  </form>
</div>

<script>
// language
(function(){
  const sw = document.getElementById('langSwitch'); if(!sw) return;
  const btn = sw.querySelector('.btn-lang');
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); sw.classList.toggle('open'); });
  document.addEventListener('click', ()=> sw.classList.remove('open'));
})();

// user menu (logout)
(function(){
  const sw = document.getElementById('userSwitch'); if(!sw) return;
  const btn = sw.querySelector('.user-btn');
  function close(){ sw.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = sw.classList.toggle('open');
    btn.setAttribute('aria-expanded', String(open));
  });
  document.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();

// modal (open only by button)
(function(){
  const o = document.getElementById('createOverlay');
  const openBtn = document.getElementById('openCreate');
  function close(){ o.classList.remove('open'); document.body.style.overflow=''; }
  openBtn && openBtn.addEventListener('click', ()=>{ o.classList.add('open'); document.body.style.overflow='hidden'; });
  o.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', close));
  o.addEventListener('click', e=>{ if(e.target===o) close(); });
})();

// kebab per row
document.querySelectorAll('.kebab-btn').forEach(btn=>{
  const wrap = btn.closest('.kebab');
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); wrap.classList.toggle('open'); });
  document.addEventListener('click', ()=> wrap.classList.remove('open'));
});

// extend / delete
document.querySelectorAll('.js-extend').forEach(b=>{
  b.addEventListener('click', async (e)=>{
    const row = e.target.closest('.kebab'); const id = row.dataset.id;
    const iso = prompt("{{ _('–ù–æ–≤–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–îT—á—á:–º–º') }}");
    if (!iso) return;
    const resp = await fetch('{{ url_for("prov.extend_access", user_id="__ID__") }}'.replace('__ID__', id), {
      method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({ access_until: iso })
    });
    if (resp.ok) location.reload(); else alert('Error');
  });
});
document.querySelectorAll('.js-delete').forEach(b=>{
  b.addEventListener('click', async (e)=>{
    const row = e.target.closest('.kebab'); const id = row.dataset.id;
    if (!confirm('{{ _("–û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?") }}')) return;
    const resp = await fetch('{{ url_for("prov.delete_user", user_id="__ID__") }}'.replace('__ID__', id), { method:'POST' });
    if (resp.ok) location.reload(); else alert('Error');
  });
});
</script>
<script>
(function(){
  const modal = document.getElementById('createOverlay');
  if(!modal) return;

  const form  = modal.querySelector('form');
  const inn   = document.getElementById('innInput');
  const phone = document.getElementById('kgPhone');

  /* ==== –ò–ù–ù –ö–†: —Ä–æ–≤–Ω–æ 14 —Ü–∏—Ñ—Ä ==== */
  const innMsg = '{{ _("–í–≤–µ–¥–∏—Ç–µ 14 —Ü–∏—Ñ—Ä –ò–ù–ù") }}';
  if (inn) {
    inn.addEventListener('input', () => {
      inn.value = inn.value.replace(/\D/g, '').slice(0,14);
      inn.setCustomValidity(inn.value.length === 14 ? '' : innMsg);
    });
  }

  /* ==== –¢–µ–ª–µ—Ñ–æ–Ω –ö–†: +996 (XXX) XXX-XXX ==== */
  const phoneMsg = '{{ _("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ +996 (XXX) XXX-XXX") }}';

  function formatKg(raw){
    const d = raw.replace(/\D/g,'');
    let num = d;

    // –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–≤–æ–¥–∞: 0XXX..., 996XXX..., –ø—Ä–æ—Å—Ç–æ 9 —Ü–∏—Ñ—Ä
    if (d.startsWith('0') && d.length >= 10) {
      num = '996' + d.slice(1,10);            // 0 + 9 —Ü–∏—Ñ—Ä ‚Üí +996 + 9 —Ü–∏—Ñ—Ä
    } else if (d.startsWith('996')) {
      num = d.slice(0,12);                    // +996 –∏ –µ—â—ë 9 —Ü–∏—Ñ—Ä
    } else {
      const tail = d.slice(-9);               // –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 9 —Ü–∏—Ñ—Ä –∫–∞–∫ NSN
      num = '996' + tail;
    }

    const nsn = num.slice(3,12);              // 9 —Ü–∏—Ñ—Ä –Ω–∞—Ü. –Ω–æ–º–µ—Ä–∞
    const a = nsn.slice(0,3), b = nsn.slice(3,6), c = nsn.slice(6,9);
    let out = '+996';
    if (a) out += ' ' + a;
    if (b) out += ' ' + b;
    if (c) out += '-' + c;
    return out;
  }

  function validatePhone(){
    const nsn = phone.value.replace(/\D/g,'').replace(/^996/,'');
    phone.setCustomValidity(nsn.length === 9 ? '' : phoneMsg);
  }

  if (phone) {
    phone.addEventListener('focus', () => { if (!phone.value) phone.value = '+996 '; });
    ['input','paste','blur'].forEach(ev => {
      phone.addEventListener(ev, () => {
        const caretEnd = document.activeElement === phone;
        phone.value = formatKg(phone.value);
        if (caretEnd) phone.selectionStart = phone.selectionEnd = phone.value.length;
        validatePhone();
      });
    });
  }

  /* ==== –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ —Å–∞–±–º–∏—Ç–æ–º ==== */
  if (form) {
    form.addEventListener('submit', (e) => {
      if (inn && inn.value.replace(/\D/g,'').length !== 14) {
        inn.reportValidity(); e.preventDefault(); return;
      }
      if (phone) {
        const nsn = phone.value.replace(/\D/g,'').replace(/^996/,'').slice(0,9);
        if (nsn.length !== 9) { phone.reportValidity(); e.preventDefault(); return; }
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º E.164-–≤–∏–¥–µ
        phone.value = '+996' + nsn;
      }
      if (inn) inn.value = inn.value.replace(/\D/g,'').slice(0,14);
    });
  }
})();
</script>

</body>
</html>
